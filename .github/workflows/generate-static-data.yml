name: Generate Static Chart Data

on:
  # Run after other crawlers complete
  workflow_run:
    workflows:
      - "Gold & Silver Price Crawl (2x Daily)"
      - "Bank Term Deposit Crawl"
      - "SBV Rates Crawl (Daily)"
      - "Exchange Rate Crawl (Daily)"
    types:
      - completed

  # Manual trigger
  workflow_dispatch:

  # Also run on schedule as backup (every 6 hours)
  schedule:
    - cron: '0 */6 * * *'

jobs:
  generate-static:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install sqlalchemy psycopg2-binary python-dotenv

    - name: Generate static data
      env:
        CRAWLING_BOT_DB: ${{ secrets.CRAWLING_BOT_DB }}
        ARGUS_FINTEL_DB: ${{ secrets.ARGUS_FINTEL_DB }}
        GLOBAL_INDICATOR_DB: ${{ secrets.GLOBAL_INDICATOR_DB }}
      run: |
        cd be
        python generate_static_data.py

    - name: List generated files
      run: |
        echo "Generated static files:"
        ls -la data/ || echo "No data directory"

    - name: Commit and push static data
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -f data/
        git diff --staged --quiet || git commit -m "Update static chart data [skip ci]"
        git push || echo "Nothing to push"

    - name: Show results
      if: always()
      run: echo "Static data generation completed at $(date)"
