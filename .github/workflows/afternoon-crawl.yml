name: Afternoon Silver Crawl

on:
  schedule:
    - cron: '30 6 * * *'  # 1:30 PM VN (6:30 AM UTC)
  workflow_dispatch:

jobs:
  crawl:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Chrome for Selenium
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser chromium-chromedriver

    - name: Install dependencies
      run: |
        cd crawl_tools
        pip install pandas requests sqlalchemy psycopg2-binary beautifulsoup4 selenium

    - name: Run silver crawler only
      run: |
        cd crawl_tools
        python -c "
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.options import Options
from datetime import datetime
from sqlalchemy import create_engine, text
import time

# Setup Chrome
opts = Options()
opts.add_argument('--headless')
opts.add_argument('--no-sandbox')
opts.add_argument('--disable-dev-shm-usage')
opts.add_argument('--disable-gpu')
opts.binary_location = '/usr/bin/chromium-browser'

driver = webdriver.Chrome(options=opts)

try:
    driver.get('https://giabac.vn/')
    time.sleep(2)

    # Click Luong button
    buttons = driver.find_elements(By.TAG_NAME, 'button')
    for btn in buttons:
        if 'Lượng' in btn.text or 'luong' in btn.text.lower():
            btn.click()
            time.sleep(2)
            break

    # Get prices
    price_div = WebDriverWait(driver, 10).until(
        EC.presence_of_element_located((By.ID, 'priceDiv'))
    )
    price_elements = price_div.find_elements(By.CSS_SELECTOR, 'p.text-24px')

    if len(price_elements) >= 2:
        buy = float(price_elements[0].text.strip().replace(',', '').replace('.', ''))
        sell = float(price_elements[1].text.strip().replace(',', '').replace('.', ''))

        conn_str = 'postgresql://neondb_owner:npg_DX5hbAHqgif1@ep-autumn-meadow-a1xklzwk-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require'
        engine = create_engine(conn_str)

        now = datetime.now()
        date_str = now.strftime('%Y-%m-%d')

        with engine.connect() as conn:
            conn.execute(text('''
                INSERT INTO vn_silver_phuquy_hist (date, crawl_time, buy_price, sell_price)
                VALUES (:date, :crawl_time, :buy_price, :sell_price)
                ON CONFLICT (date, crawl_time) DO NOTHING
            '''), {'date': date_str, 'crawl_time': now, 'buy_price': buy, 'sell_price': sell})
            conn.commit()

        print(f'Silver crawled: {now.strftime(\"%H:%M\")} | Buy {buy:,.0f} | Sell {sell:,.0f}')
finally:
    driver.quit()
"

    - name: Show results
      if: always()
      run: echo "Afternoon silver crawl completed"
