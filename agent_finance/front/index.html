<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>Hien's Agent | Ask Finance</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Sora:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lobster&family=Pacifico&family=Style+Script&display=swap&subset=vietnamese" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxuvwv/b4jzlGC62Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="icon" href="https://ik.imagekit.io/o2u9hny2s/datanlanh/icon.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

    <link rel="stylesheet" href="styles.css" />
    <script type="text/javascript">
        window.API_BASE = 'https://nguyenphamdieuhien.online';
        window.httpPost = async function(url, body){
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type':'application/json' },
                body: JSON.stringify(body)
            });
            if (!res.ok) {
                let msg = `HTTP ${res.status} ${res.statusText}`;
                try {
                    const j = await res.json();
                    if (j && j.detail) msg = j.detail;
                } catch {}
                throw new Error(msg);
            }
            return res.json();
        };

        // Toast Notification System
        window.showToast = function(message, type = 'info', title = null, duration = 5000) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: '‚úì',
                error: '‚úï',
                warning: '‚ö†',
                info: '‚Ñπ'
            };

            const titles = {
                success: title || 'Th√†nh c√¥ng',
                error: title || 'L·ªói',
                warning: title || 'C·∫£nh b√°o',
                info: title || 'Th√¥ng b√°o'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-content">
                    <div class="toast-title">${titles[type]}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.closest('.toast').remove()">√ó</button>
            `;

            container.appendChild(toast);

            // Auto remove after duration
            if (duration > 0) {
                setTimeout(() => {
                    toast.classList.add('removing');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
        };

        // Replace alert() with toast
        const originalAlert = window.alert;
        window.alert = function(message) {
            const type = message.toLowerCase().includes('l·ªói') || message.toLowerCase().includes('error') || message.toLowerCase().includes('failed')
                ? 'error'
                : message.toLowerCase().includes('th√†nh c√¥ng') || message.toLowerCase().includes('success')
                ? 'success'
                : message.toLowerCase().includes('c·∫£nh b√°o') || message.toLowerCase().includes('warning')
                ? 'warning'
                : 'info';
            
            window.showToast(message, type);
        };

        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};

        function filledCell(cell) {
            return cell !== '' && cell != null;
        }

        function loadFileData(filename) {
            if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
                try {
                    var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];
                    var jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        header: 1,
                        blankrows: false,
                        defval: ''
                    });

                    var filteredData = jsonData.filter(row => row.some(filledCell));

                    var headerRowIndex = filteredData.findIndex((row, index) =>
                        row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                    );

                    if (headerRowIndex === -1 || headerRowIndex > 25) headerRowIndex = 0;

                    var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                    csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });

                    return csv;
                } catch (e) {
                    console.error(e);
                    return "";
                }
            }
            return gk_fileData[filename] || "";
        }
    </script>
</head>
<body class="index-page">
    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Animated background -->
    <div class="bg-particles" id="bgParticles"></div>

    <!--BAR-->
    <div style="position: relative; z-index: 1;">
        <nav class="py-2 md:py-3">
            <div class="w-full px-4 md:px-6 xl:px-[220px]">
                <div class="glass-elevated rounded-xl sm:rounded-2xl px-3 py-2 md:px-4 md:py-3 flex items-center justify-between gap-2 sm:gap-4">
                    <!-- Logo + text -->
                    <a href="index.html" class="flex items-center gap-2 sm:gap-3 min-w-0">
                        <div class="leading-tight truncate">
                            <p class="text-[15px] sm:text-[18px] lg:text-[20px] uppercase tracking-wider font-bold text-white/90">Hien's Agent | Ask Finance</p>
                        </div>
                    </a>

                    <!-- NAVIGATION LINKS + ACCOUNT BUTTONS -->
                    <div class="flex items-center gap-2 sm:gap-3">
                        <div class="hidden sm:flex items-center gap-2">
                            <a href="ai.html" class="tab-btn tab-btn--sm">
                                <span>Ask Finance</span>
                            </a>

                            <!-- Auth0 Login button -->
                            <a href="/auth/login" class="auth0-login-btn rounded-full bg-blue-600 px-4 py-2 text-white transition hover:bg-blue-700 shadow-lg shadow-blue-900/20">
                                <i class="fab fa-google mr-2"></i><span>Login with Google</span>
                            </a>

                            <!-- Logout button shown after login -->
                            <button class="logoutBtn hidden rounded-full border border-red-200/60 px-4 py-2 text-red-700 bg-white/70 transition hover:bg-red-50">
                                <i class="fas fa-sign-out-alt mr-2"></i><span>Logout</span>
                            </button>

                            <button class="loginToggleBtn rounded-full bg-slate-900 px-4 py-2 text-white transition hover:bg-slate-800 shadow-lg shadow-slate-900/20">
                                <span data-i18n="login">T√†i kho·∫£n</span>
                            </button>
                        </div>

                        <!-- HAMBURGER: ch·ªâ hi·ªán tr√™n mobile -->
                        <button id="navMenuBtn" class="sm:hidden inline-flex items-center justify-center h-9 w-9 rounded-lg border border-white/30 text-white/90" aria-expanded="false" aria-controls="mobileMenu" aria-label="Open menu">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                                <path d="M3 6h18v2H3V6zm0 5.5h18v2H3v-2zM3 17h18v2H3v-2z"/>
                            </svg>
                        </button>

                        <!-- MOBILE MENU (dropdown) -->
                        <div id="mobileMenu" class="sm:hidden hidden">
                            <div id="navOverlay" class="nav-overlay"></div>
                            <aside class="mobile-drawer" role="dialog" aria-modal="true" aria-label="Mobile menu">
                                <div class="drawer-header flex items-center justify-between px-4 py-3 border-b">
                                    <div class="flex items-center gap-2">
                                        <img src="https://ik.imagekit.io/o2u9hny2s/datanlanh/icon.png" alt="datanlanh" class="h-8 w-8 object-contain"/>
                                        <span class="font-semibold text-slate-800">Menu</span>
                                    </div>
                                    <button id="drawerCloseBtn" class="text-slate-700 hover:text-slate-900 font-semibold" aria-label="Close menu">
                                        <span class="text-xl" aria-hidden="true">&times;</span>
                                        <span class="ml-2">ƒê√≥ng</span>
                                    </button>
                                </div>

                                <div class="drawer-content p-4">
                                    <div id="drawerScreenMenu" class="drawer-screen h-full flex flex-col">
                                        <div class="MobileNavContent">
                                            <nav class="MegaMenuWrapper mobile">
                                                <div class="MegaMenu active">
                                                    <div class="MegaMenu__Selector">
                                                        <p class="MegaMenu__Title">Kh√°m ph√°</p>
                                                        <div class="MegaMenu__Caret" tabindex="0"></div>
                                                    </div>
                                                    <div class="MegaMenu__Dropdown">
                                                        <div class="MenuList">
                                                            <button class="mobile-tab-item" onclick="window.location.href='index.html'">Mua - Thu√™ - Sang nh∆∞·ª£ng</button>
                                                            <button class="mobile-tab-item" onclick="window.location.href='brokers.html'">Nh√† M√¥i Gi·ªõi</button>
                                                            <button class="mobile-tab-item" onclick="window.location.href='ai.html'">AI T∆∞ V·∫•n</button>
                                                            <!-- <button class="mobile-tab-item" onclick="window.location.href='finance.html'">Gi·∫£i Ph√°p T√†i Ch√≠nh</button> -->
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="MegaMenu">
                                                    <div class="MegaMenu__Selector">
                                                        <p class="MegaMenu__Title">T√†i kho·∫£n</p>
                                                        <div class="MegaMenu__Caret" tabindex="0"></div>
                                                    </div>
                                                    <div class="MegaMenu__Dropdown">
                                                        <div class="MenuList">
                                                            <button class="loginToggleBtn MenuLink" onclick="openAuth('login')">
                                                                <i class="fas fa-sign-in-alt mr-2"></i>ƒêƒÉng nh·∫≠p
                                                            </button>
                                                            <button class="signupToggleBtn MenuLink" onclick="openAuth('signup')">
                                                                <i class="fas fa-user-plus mr-2"></i>ƒêƒÉng k√Ω
                                                            </button>
                                                            <button class="logoutBtn MenuLink hidden">
                                                                <i class="fas fa-sign-out-alt mr-2"></i>ƒêƒÉng xu·∫•t
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </nav>
                                        </div>
                                    </div>
                                </div>
                            </aside>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="w-full h-screen px-4 md:px-6 xl:px-[220px] py-4 flex flex-col overflow-hidden">
            
            <div class="glass rounded-2xl p-4 md:p-6 ai-panel flex flex-col flex-1 overflow-hidden min-h-0">
                
                <div class="flex-shrink-0 mb-4 pb-4 border-b border-white/20">
                    <div class="flex items-start gap-3">
                        <div class="flex-1">
                            <p class="text-slate-700 text-sm">user email: <span id="umemail" class="font-semibold"></span></p>
                            <p class="text-slate-700 text-sm">user role: <span id="umrole" class="font-semibold"></span></p>
                            <p class="text-slate-700 text-sm">due to limited ai quota, there can only around 10 questions/day</p>
                        </div>
                    </div>
                </div>

                <div id="aiChat" class="flex-1 overflow-y-auto rounded-xl bg-white/50 p-3 md:p-4 mb-3 space-y-3 scroll-smooth">
                    <div class="glass rounded-2xl px-3 py-2 md:px-4 md:py-3 border-l-4 border-blue-500">
                        <p class="text-sm md:text-base text-gray-800 leading-relaxed font-medium">Hello! I'm Ask Finance. I can help you with your finance questions.</p>
                    </div>
                </div>

                <div class="flex-shrink-0 space-y-3">
                    <div id="aiTyping" class="hidden flex items-center gap-2 text-xs text-gray-500 px-2">
                        <div class="flex gap-1">
                            <span class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></span>
                            <span class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                            <span class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
                        </div>
                        <span>I'm thinking...</span>
                    </div>

                    <div id="uploadedFilesContainer" class="hidden">
                        <div class="bg-blue-50 rounded-xl p-3 border-2 border-blue-200">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-semibold text-blue-800"><i class="fas fa-paperclip mr-1"></i> Attached Files:</span>
                                <button onclick="clearUploadedFiles()" class="text-xs text-blue-600 hover:text-blue-800">Clear all</button>
                            </div>
                            <div id="uploadedFilesList" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                    
                    <div class="border-t bg-white/80 backdrop-blur-sm rounded-xl p-2 shadow-inner">
                        <form id="aiForm" class="flex items-end gap-2 w-full">
                            <label class="flex items-center justify-center w-11 h-11 rounded-xl border-2 border-gray-300 bg-white hover:border-blue-400 transition cursor-pointer shadow-sm flex-shrink-0" title="Upload file">
                                <i class="fas fa-upload text-blue-600"></i>
                                <input type="file" id="fileUploadInput" accept=".csv,.xlsx,.xls,.pdf" class="hidden" onchange="handleFileUpload(event)"/>
                            </label>

                            <button type="button" onclick="showUploadedFilesModal()" title="My files" class="flex items-center justify-center w-11 h-11 rounded-xl border-2 border-gray-300 bg-white hover:border-blue-400 transition shadow-sm flex-shrink-0">
                                <i class="fas fa-folder-open text-blue-600"></i>
                            </button>

                            <textarea id="aiInput" rows="1" placeholder="Type your question here..." class="flex-1 resize-none rounded-xl border-2 border-gray-200 focus:border-blue-400 focus:outline-none px-4 py-2.5 text-sm md:text-base bg-white transition-colors min-h-[44px] max-h-[120px]"></textarea>

                            <button type="submit" title="Send" class="flex items-center justify-center w-11 h-11 rounded-xl bg-blue-600 hover:bg-blue-700 text-white shadow-lg transition-all flex-shrink-0">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Overlay -->
    <div id="overlay" class="overlay"></div>

    <!-- Auth Panel -->
    <div id="loginPanel" class="fixed top-0 right-0 h-full w-full max-w-md glass-elevated z-50 p-4 sm:p-8 overflow-y-auto">
        <button type="button" onclick="closeAuth()" class="absolute right-6 top-6 text-gray-400 hover:text-gray-600 text-xl">
            <i class="fas fa-times"></i>
        </button>

        <h3 class="text-2xl font-bold mb-6">Account</h3>

        <div class="form-section flex gap-2 mb-6 p-1 bg-gray-100 rounded-xl">
            <button type="button" id="tabLogin" class="flex-1 py-2 rounded-lg font-semibold transition" onclick="switchAuthTab('login')">
                Login
            </button>
            <button id="tabSignup" class="flex-1 py-2 rounded-lg font-semibold transition" onclick="switchAuthTab('signup')">
                Signup
            </button>
        </div>

        <form id="loginForm" class="form-section space-y-4">
            <div>
                <label for="email" class="block text-sm font-semibold mb-2">Email</label>
                <input type="email" id="email" required>
            </div>
            <div>
                <label for="password" class="block text-sm font-semibold mb-2">Password</label>
                <div class="relative">
                    <input type="password" id="password" required>
                    <button type="button" onclick="toggleEye('password')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                        <i class="far fa-eye"></i>
                    </button>
                </div>
            </div>
            <label class="flex items-center gap-2 text-sm">
                <input id="rememberMe" type="checkbox" class="w-4 h-4 rounded">
                <span>Remember my password</span>
            </label>
            <button id="loginBtn" type="submit" class="btn-primary w-full">
                Login
            </button>
        </form>

        <form id="signupForm" class="form-section space-y-4 hidden">
            <div>
                <label class="block text-sm font-semibold mb-2">Email</label>
                <input type="email" id="su_email" required>
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2">Password</label>
                <div class="relative">
                    <input type="password" id="su_password" minlength="6" required>
                    <button type="button" onclick="toggleEye('su_password')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                        <i class="far fa-eye"></i>
                    </button>
                </div>
            </div>
            <button id="signupBtn" type="submit" class="btn-primary w-full">
                Create Account
            </button>
        </form>
    </div>

    <!-- Login -->
    <script>

        // CLAUDE
        // Pagination state
        let currentPage = 0;
        const itemsPerPage = 20;
        let isLoading = false;
        let hasMore = true;

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        /**
         * Load current user info (email, role) and bind to UI
         */
        async function loadCurrentUserInfo() {
            const emailEl = document.getElementById('umemail');
            const roleEl  = document.getElementById('umrole');

            if (!emailEl || !roleEl) return;

            const token = localStorage.getItem('access_token');
            if (!token) {
                emailEl.textContent = 'Guest';
                roleEl.textContent = '-';
                return;
            }

            try {
                const res = await fetch(`${window.API_BASE.replace(/\/$/, '')}/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const data = await res.json();

                // Email
                emailEl.textContent = data.email || localStorage.getItem('user_email') || 'Unknown';

                // Role (support string | array)
                if (Array.isArray(data.roles)) {
                    roleEl.textContent = data.roles.join(', ');
                } else {
                    roleEl.textContent = data.role || 'user';
                }

            } catch (err) {
                console.warn('[loadCurrentUserInfo]', err);

                // Token invalid / expired
                emailEl.textContent = 'Guest';
                roleEl.textContent = '-';

                try { localStorage.removeItem('access_token'); } catch {}
            }
        }

        /**
         * Auto load on page ready
         */
        document.addEventListener('DOMContentLoaded', loadCurrentUserInfo);

        /**
         * Reload when token changes (login / logout in another tab)
         */
        window.addEventListener('storage', (e) => {
            if (e.key === 'access_token') {
                loadCurrentUserInfo();
            }
        });

        // // Create animated particles
        // (function createParticles() {
        //     const container = document.getElementById('bgParticles');
        //     if (!container) return;

        //     for (let i = 0; i < 15; i++) {
        //         const particle = document.createElement('div');
        //         particle.className = 'particle';
        //         const size = Math.random() * 80 + 20;
        //         particle.style.width = size + 'px';
        //         particle.style.height = size + 'px';
        //         particle.style.left = Math.random() * 100 + '%';
        //         particle.style.animationDuration = (Math.random() * 15 + 10) + 's';
        //         particle.style.animationDelay = Math.random() * 5 + 's';
        //         container.appendChild(particle);
        //     }
        // })();

        // API Configuration
        const API_BASE = (function(){
            const env = window.API_BASE || window.API_BASE;
            if (env) return env.replace(/\/$/, '');
            const host = location.hostname;
            if (host === 'localhost' || host === '127.0.0.1') return 'http://localhost:8000';
            return '/api';
        })();

        // Helper Functions
        function getToken() {
            return localStorage.getItem("access_token") || '';
        }

        function getEmail() {
            return localStorage.getItem("user_email") || '';
        }

        const overlay = document.getElementById('overlay');
        const panel = document.getElementById('loginPanel');

        function openAuth(which='login'){
            switchAuthTab(which);
            overlay?.classList.add('show');
            panel?.classList.add('slide-in');
        }

        function closeAuth(){
            overlay?.classList.remove('show');
            panel?.classList.remove('slide-in');
        }

        function switchAuthTab(which){
            const isLogin = which === 'login';
            const tabLogin = document.getElementById('tabLogin');
            const tabSignup = document.getElementById('tabSignup');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');

            if (isLogin) {
                tabLogin.classList.add('bg-white', 'shadow-md');
                tabSignup.classList.remove('bg-white', 'shadow-md');
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
            } else {
                tabSignup.classList.add('bg-white', 'shadow-md');
                tabLogin.classList.remove('bg-white', 'shadow-md');
                signupForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        }

        function toggleEye(inputId){
            const el = document.getElementById(inputId);
            if (!el) return;
            const icon = el.nextElementSibling?.querySelector('i');
            if (el.type === 'password') {
                el.type = 'text';
                if (icon) icon.className = 'fas fa-eye-slash';
            } else {
                el.type = 'password';
                if (icon) icon.className = 'far fa-eye';
            }
        }

        overlay?.addEventListener('click', closeAuth);
        document.addEventListener('keydown', (e)=>{
            if(e.key === 'Escape') closeAuth();
        });

        function updateUIAfterLogin(email){
            document.querySelectorAll('.logoutBtn').forEach(btn => btn.classList.remove('hidden'));
            document.querySelectorAll('.loginToggleBtn').forEach(btn => btn.classList.add('hidden'));
            document.querySelectorAll('.signupToggleBtn').forEach(btn => btn.classList.add('hidden'));
        }

        function doLogout(){
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_email');
            localStorage.removeItem('remember_me');
            document.querySelectorAll('.logoutBtn').forEach(btn => btn.classList.add('hidden'));
            document.querySelectorAll('.loginToggleBtn').forEach(btn => btn.classList.remove('hidden'));
            document.querySelectorAll('.signupToggleBtn').forEach(btn => btn.classList.remove('hidden'));
            window.showToast('Logout successfully.', 'success');
            setTimeout(() => location.reload(), 500);
        }

        // Auth Functions
        async function doLogin(email, password, remember){
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Login...';

            try{
                const res = await fetch(`${API_BASE}/login`, {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ email, password })
                });

                const data = await res.json();
                if(!res.ok) throw new Error(data.detail || 'Login failed');
                if (!data.access_token) throw new Error('No access token received');

                localStorage.setItem('access_token', data.access_token);
                localStorage.setItem('user_email', data.email || email);
                if (remember) localStorage.setItem('remember_me','1');
                else localStorage.removeItem('remember_me');

                updateUIAfterLogin(data.email || email);
                loadCurrentUserInfo();   // üî• B·∫ÆT BU·ªòC
                closeAuth();
                window.showToast('Login successfully.', 'success');
            }catch(err){
                alert(err.message || 'Connection fail');
            }finally{
                loginBtn.disabled = false;
                loginBtn.innerHTML = 'Login';
            }
        }

        async function doSignup(email, password){
            const signupBtn = document.getElementById('signupBtn');
            signupBtn.disabled = true;
            signupBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating account...';

            try{
                const payload = { email, password };
                await window.httpPost(`${API_BASE}/register`, payload);
                window.showToast('Create account successfully. Login now', 'success');
                switchAuthTab('login');
            }catch(err){
                window.showToast(err.message || 'Sign Up fail', 'error');
            }finally{
                signupBtn.disabled = false;
                signupBtn.innerHTML = 'Create account';
            }
        }

        document.getElementById('loginForm')?.addEventListener('submit', (e)=>{
            e.preventDefault();
            const email = (document.getElementById('email')?.value || '').trim();
            const password = document.getElementById('password').value;
            const remember = document.getElementById('rememberMe').checked;
            doLogin(email, password, remember);
        });

        document.getElementById('signupForm')?.addEventListener('submit', (e)=>{
            e.preventDefault();
            const password = document.getElementById('su_password').value;
            const email = (document.getElementById('su_email')?.value || '').trim();

            // Validation
            if (!email){
                window.showToast('Input your email', 'warning');
                return;
            }
            if (password.length < 6){
                window.showToast('Password must be over 6 letters', 'warning');
                return;
            }

            doSignup(email, password);
        });

        // Logout navigation
        document.querySelectorAll('.logoutBtn').forEach(btn => btn.addEventListener('click', doLogout));
        document.querySelectorAll('.loginToggleBtn').forEach(btn => btn.addEventListener('click', ()=>openAuth('login')));

        // Toggle Logout vs Login buttons based on auth
        (function ensureAccountNav(){
            async function apply(){
                const logoutEls = document.querySelectorAll('.logoutBtn');
                const loginEls = document.querySelectorAll('.loginToggleBtn, #loginToggleBtn');
                const signupEls = document.querySelectorAll('.signupToggleBtn, #signupToggleBtn');

                const hide = (els)=> els.forEach(el => el.classList.add('hidden'));
                const show = (els)=> els.forEach(el => el.classList.remove('hidden'));

                const token = (typeof getToken === 'function') ? getToken() : (localStorage.getItem('access_token')||'');

                if (!token) {
                    hide(logoutEls);
                    show(loginEls);
                    show(signupEls);
                    return;
                }

                try {
                    const base = (window.API_BASE || '').replace(/\/$/, '');
                    const res = await fetch(base + '/me', {
                        headers:{ 'Authorization': `Bearer ${token}` }
                    });
                    if (!res.ok) throw new Error(String(res.status));

                    hide(loginEls);
                    hide(signupEls);
                    show(logoutEls);
                } catch {
                    try { localStorage.removeItem('access_token'); } catch {}
                    hide(logoutEls);
                    show(loginEls);
                    show(signupEls);
                }
            }

            document.addEventListener('DOMContentLoaded', apply);
            try{ apply(); }catch{}
            window.refreshAccountNav = apply;
            window.addEventListener('storage', (e)=>{
                if (e.key === 'access_token') apply();
            });
        })();

        // AREA FOR FEATURE TABS (GALLERY, SERVICES)
        (() => {
            const btn = document.getElementById('navMenuBtn');
            const menu = document.getElementById('mobileMenu');
            if(!btn || !menu) return;

            const iconBars = document.getElementById('navIconBars');
            const iconClose = document.getElementById('navIconClose');

            // Toggle menu
            btn.addEventListener('click', () => {
                const isOpen = menu.classList.contains('open');
                if (isOpen) {
                    menu.classList.remove('open');
                    menu.classList.add('hidden');
                    btn.setAttribute('aria-expanded','false');
                    iconClose?.classList.add('hidden');
                    iconBars?.classList.remove('hidden');
                    document.body.classList.remove('drawer-open');
                } else {
                    menu.classList.remove('hidden');
                    menu.classList.add('open');
                    btn.setAttribute('aria-expanded','true');
                    iconBars?.classList.add('hidden');
                    iconClose?.classList.remove('hidden');
                    document.body.classList.add('drawer-open');
                }
            });

            // Click outside to close menu
            document.addEventListener('click', (e) => {
                if(menu.classList.contains('hidden')) return;
                if(!menu.contains(e.target) && !btn.contains(e.target)){
                    menu.classList.remove('open');
                    menu.classList.add('hidden');
                    btn.setAttribute('aria-expanded','false');
                    iconClose?.classList.add('hidden');
                    iconBars?.classList.remove('hidden');
                    document.body.classList.remove('drawer-open');
                }
            });

            // switchTab
            menu.querySelectorAll('.mobile-tab-item').forEach(it => {
                it.addEventListener('click', () => {
                    const tab = it.getAttribute('data-tab');
                    const targetBtn = document.getElementById(`tab-${tab}`);
                    if (targetBtn) {
                        targetBtn.focus();
                        targetBtn.click();
                    } else if (typeof window.switchTab === 'function') {
                        window.switchTab(tab);
                    }

                    menu.classList.remove('open');
                    menu.classList.add('hidden');
                    btn.setAttribute('aria-expanded','false');
                    iconClose?.classList.add('hidden');
                    iconBars?.classList.remove('hidden');
                    document.body.classList.remove('drawer-open');
                });
            });

            // N·∫øu resize sang ‚â•640px th√¨ ƒë√≥ng menu
            const mql = window.matchMedia('(min-width: 640px)');
            mql.addEventListener?.('change', e => {
                if(e.matches){
                    menu.classList.remove('open');
                    menu.classList.add('hidden');
                    btn.setAttribute('aria-expanded','false');
                    document.body.classList.remove('drawer-open');
                }
            });
        })();

        // Drawer extras: overlay, close button, and inline auth toggle
        (() => {
            const menu = document.getElementById('mobileMenu');
            const overlay = document.getElementById('navOverlay');
            const closeBtn = document.getElementById('drawerCloseBtn');
            const iconBars = document.getElementById('navIconBars');
            const iconClose = document.getElementById('navIconClose');

            function closeDrawer(){
                menu.classList.remove('open');
                menu.classList.add('hidden');
                const btn = document.getElementById('navMenuBtn');
                btn?.setAttribute('aria-expanded','false');
                iconClose?.classList.add('hidden');
                iconBars?.classList.remove('hidden');
                document.body.classList.remove('drawer-open');
            }

            overlay?.addEventListener('click', closeDrawer);
            closeBtn?.addEventListener('click', closeDrawer);
            document.addEventListener('keydown', (e)=>{
                if(e.key === 'Escape') closeDrawer();
            });

            document.querySelectorAll('.loginToggleBtn, .signupToggleBtn').forEach(el => {
                el.addEventListener('click', (e) => {
                    if (el.closest('.mobile-drawer')) {
                        closeDrawer();
                    }
                });
            });

            document.querySelectorAll('.logoutBtn').forEach(el =>
                el.addEventListener('click', ()=>{
                    closeDrawer();
                    doLogout();
                })
            );

            const selectors = menu.querySelectorAll('.MegaMenu__Selector');
            selectors.forEach(sel => {
                sel.addEventListener('click', () => {
                    const mm = sel.closest('.MegaMenu');
                    const wasActive = mm.classList.contains('active');
                    menu.querySelectorAll('.MegaMenu').forEach(m => m.classList.remove('active'));
                    if (!wasActive) mm.classList.add('active');
                });
            });
        })();
    </script>

    <!-- AI Chat widget -->
    <script>
        (function initAIChat(){
            const form = document.getElementById('aiForm');
            const input = document.getElementById('aiInput');
            const chat = document.getElementById('aiChat');
            const typing = document.getElementById('aiTyping');
            const modelSel = document.getElementById('aiModel');

            if (!form || !input || !chat) return;

            // Set AI panel to full screen height
            function setAIPanelHeight() {
                const aiPanel = document.querySelector('.ai-panel');
                const nav = document.querySelector('nav');
                const main = document.querySelector('main');

                if (aiPanel && nav && main) {
                    const navHeight = nav.offsetHeight;
                    const mainPaddingTop = parseInt(getComputedStyle(main).paddingTop) || 0;
                    const mainPaddingBottom = parseInt(getComputedStyle(main).paddingBottom) || 0;
                    const availableHeight = window.innerHeight - navHeight - mainPaddingTop - mainPaddingBottom;

                    aiPanel.style.height = availableHeight + 'px';
                    aiPanel.style.maxHeight = availableHeight + 'px';
                }
            }

            // Set height on load and resize
            setAIPanelHeight();
            window.addEventListener('resize', setAIPanelHeight);

            // Lock body scroll
            document.body.classList.add('ai-body-lock');

            // Try load available models from backend
            (async function loadModels(){
                try{
                    const res = await fetch((window.API_BASE||'').replace(/\/$/, '') + '/ai/models');
                    const list = await res.json();
                    if (res.ok && Array.isArray(list) && list.length){
                        modelSel.innerHTML = '';
                        list.forEach(name => {
                            const opt = document.createElement('option');
                            opt.value = name.replace(/^models\//,'');
                            opt.textContent = opt.value;
                            modelSel.appendChild(opt);
                        });
                    }
                }catch{}
            })();

            // Format AI response with markdown-like styling
            function formatAIResponse(text) {
                text = text.replace(/\*\*(.+?)\*\*/g, '<strong class="font-bold text-gray-900">$1</strong>');
                text = text.replace(/^# (.+)$/gm, '<h3 class="text-lg font-bold text-gray-900 mt-3 mb-2">$1</h3>');
                text = text.replace(/^## (.+)$/gm, '<h4 class="text-base font-bold text-gray-800 mt-2 mb-1">$1</h4>');
                text = text.replace(/^(\d+)\.\s+(.+)$/gm, '<div class="ml-4 mb-1"><span class="font-semibold text-blue-600">$1.</span> $2</div>');
                text = text.replace(/^[-‚Ä¢]\s+(.+)$/gm, '<div class="ml-4 mb-1"><span class="text-blue-600">‚Ä¢</span> $1</div>');
                text = text.replace(/\n\n/g, '<br/><br/>');
                text = text.replace(/\n/g, '<br/>');
                return text;
            }

            function addBubble(text, who){
                const bubble = document.createElement('div');
                if (who === 'user') {
                    bubble.className = 'glass rounded-2xl px-3 py-2 md:px-4 md:py-3 ml-auto max-w-[85%] bg-blue-50 border-l-4 border-blue-500';
                    bubble.innerHTML = `<p class="text-sm md:text-base text-gray-800">${text}</p>`;
                } else {
                    bubble.className = 'glass rounded-2xl px-3 py-2 md:px-4 md:py-3 max-w-[95%] border-l-4 border-green-500';
                    bubble.innerHTML = `<div class="text-sm md:text-base text-gray-700 leading-relaxed ai-response">${formatAIResponse(text)}</div>`;
                }
                chat.appendChild(bubble);
                chat.scrollTop = chat.scrollHeight;
            }

            async function sendMessage(e){
                e.preventDefault();
                const msg = input.value.trim();
                if (!msg) return;

                const token = localStorage.getItem('access_token') || '';
                if (!token){
                    showLoginRequiredModal();
                    return;
                }

                addBubble(msg, 'user');
                input.value = '';
                typing?.classList.remove('hidden');

                try{
                    const file_ids = (window.uploadedFiles || []).map(f => f.file_id);
                    const payload = {
                        message: msg,
                        model: (modelSel?.value || 'gemini-1.5-flash'),
                        file_ids: file_ids.length > 0 ? file_ids : null
                    };

                    const res = await fetch((window.API_BASE||'').replace(/\/$/, '') + '/ai/chat', {
                        method:'POST',
                        headers:{
                            'Content-Type':'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json().catch(()=>({}));

                    if (res.status === 401){
                        try { alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.'); } catch{}
                        try { localStorage.removeItem('access_token'); } catch{}
                        try { openAuth && openAuth('login'); } catch{}
                        return;
                    }

                    if (!res.ok) throw new Error(data?.detail || ('HTTP '+res.status));

                    addBubble(String(data?.response || '').trim() || '', 'ai');

                    // Clear uploaded files after successful chat
                    if (window.clearUploadedFiles) window.clearUploadedFiles();

                }catch(err){
                    console.error('[AI chat]', err);
                    const msg = String(err?.message || '');
                    if (/AI service not configured|503/.test(msg)){
                        addBubble('AI ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh. Vui l√≤ng ƒë·∫∑t GOOGLE_API_KEY (ho·∫∑c GEMINI_API_KEY) cho backend v√† c√†i google-generativeai.', 'ai');
                    } else if (/model unavailable|404|not found|not supported/i.test(msg)){
                        addBubble('Model kh√¥ng kh·∫£ d·ª•ng ho·∫∑c kh√¥ng h·ªó tr·ª£ generateContent. H√£y ch·ªçn model kh√°c trong danh s√°ch.', 'ai');
                    } else {
                        addBubble('Kh√¥ng g·ª≠i ƒë∆∞·ª£c: ' + msg, 'ai');
                    }
                }finally{
                    typing?.classList.add('hidden');
                }
            }

            form.addEventListener('submit', sendMessage);

            // Handle Enter key to submit (Shift+Enter for new line)
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    form.dispatchEvent(new Event('submit'));
                }
            });
        })();
    </script>

    <!-- ====== Login Required Modal ====== -->
    <script>
        function showLoginRequiredModal() {
            const loginModal = document.getElementById('loginRequiredModal');
            const loginBtn = document.getElementById('loginRequiredBtn');
            const cancelBtn = document.getElementById('cancelLoginRequired');

            if (!loginModal) return;

            loginModal.classList.remove('hidden');
            document.body.classList.add('drawer-open');

            setTimeout(() => {
                loginModal.classList.remove('opacity-0');
                const content = loginModal.querySelector('.modal-content');
                if (content) {
                    content.classList.remove('scale-95');
                    content.classList.add('scale-100');
                }
            }, 10);

            const handleLogin = () => {
                hideLoginRequiredModal();
                setTimeout(() => {
                    try { openAuth('login'); } catch {}
                }, 150);
            };

            const handleCancel = () => {
                hideLoginRequiredModal();
            };

            loginBtn?.removeEventListener('click', handleLogin);
            cancelBtn?.removeEventListener('click', handleCancel);

            loginBtn?.addEventListener('click', handleLogin);
            cancelBtn?.addEventListener('click', handleCancel);

            const overlay = loginModal.querySelector('.absolute.inset-0');
            const overlayHandler = (e) => {
                if (e.target === overlay) handleCancel();
            };
            overlay?.removeEventListener('click', overlayHandler);
            overlay?.addEventListener('click', overlayHandler);
        }

        function hideLoginRequiredModal() {
            const loginModal = document.getElementById('loginRequiredModal');
            if (!loginModal) return;

            const content = loginModal.querySelector('.modal-content');
            loginModal.classList.add('opacity-0');
            if (content) {
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
            }

            setTimeout(() => {
                loginModal.classList.add('hidden');
                document.body.classList.remove('drawer-open');
            }, 300);
        }
    </script>

    <!-- ====== File Upload Functionality ====== -->
    <script>
        window.uploadedFiles = []; // Array to store {file_id, filename, file_type} - global for access in chat

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const token = localStorage.getItem('access_token') || localStorage.getItem('token');
            if (!token) {
                showToast('Please login to upload files', 'error');
                return;
            }

            // Show uploading toast
            showToast(`Uploading ${file.name}...`, 'info', 'Upload', 0);

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${window.API_BASE}/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Upload failed');
                }

                const result = await response.json();

                // Add to uploaded files list
                window.uploadedFiles.push({
                    file_id: result.file_id,
                    filename: result.filename,
                    file_type: result.file_type
                });

                updateUploadedFilesDisplay();
                showToast(`${file.name} uploaded successfully!`, 'success');

                // Clear input
                event.target.value = '';

            } catch (error) {
                showToast(error.message, 'error', 'Upload Failed');
            }
        }

        window.updateUploadedFilesDisplay = function() {
            const container = document.getElementById('uploadedFilesContainer');
            const list = document.getElementById('uploadedFilesList');

            if (window.uploadedFiles.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            list.innerHTML = window.uploadedFiles.map((file, index) => `
                <div class="bg-white rounded-lg px-3 py-2 text-sm flex items-center gap-2 border border-blue-300">
                    <i class="fas fa-file-${file.file_type === 'PDF' ? 'pdf text-red-500' : file.file_type === 'Excel' ? 'excel text-green-500' : 'csv text-blue-500'}"></i>
                    <span class="font-medium">${file.filename}</span>
                    <button onclick="removeUploadedFile(${index})" class="ml-2 text-red-500 hover:text-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        window.removeUploadedFile = function(index) {
            window.uploadedFiles.splice(index, 1);
            window.updateUploadedFilesDisplay();
        }

        window.clearUploadedFiles = function() {
            window.uploadedFiles = [];
            window.updateUploadedFilesDisplay();
        }

        async function showUploadedFilesModal() {
            const token = localStorage.getItem('access_token') || localStorage.getItem('token');
            if (!token) {
                showToast('Please login to view files', 'error');
                return;
            }

            try {
                const response = await fetch(`${window.API_BASE}/files`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load files');

                const data = await response.json();
                const files = data.files || [];

                if (files.length === 0) {
                    showToast('No files uploaded yet', 'info');
                    return;
                }

                // Create modal
                const modalHTML = `
                    <div id="filesModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden shadow-2xl">
                            <div class="bg-gradient-to-r from-blue-600 to-cyan-600 p-6 text-white flex justify-between items-center">
                                <h3 class="text-xl font-bold"><i class="fas fa-folder-open mr-2"></i>My Uploaded Files</h3>
                                <button onclick="closeFilesModal()" class="text-white hover:text-gray-200">
                                    <i class="fas fa-times text-2xl"></i>
                                </button>
                            </div>
                            <div class="p-6 overflow-y-auto max-h-[60vh]">
                                <div class="space-y-3">
                                    ${files.map(file => `
                                        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                                            <div class="flex items-start justify-between">
                                                <div class="flex items-start gap-3 flex-1">
                                                    <i class="fas fa-file-${file.file_type === 'PDF' ? 'pdf text-red-500' : file.file_type === 'Excel' ? 'excel text-green-500' : 'csv text-blue-500'} text-2xl mt-1"></i>
                                                    <div class="flex-1">
                                                        <h4 class="font-semibold text-gray-800">${file.filename}</h4>
                                                        <p class="text-sm text-gray-500 mt-1">${file.file_type} ‚Ä¢ ${(file.file_size / 1024).toFixed(2)} KB</p>
                                                        <p class="text-xs text-gray-400 mt-1">${new Date(file.uploaded_at).toLocaleString()}</p>
                                                    </div>
                                                </div>
                                                <div class="flex gap-2">
                                                    <button onclick="attachFile('${file.file_id}', '${file.filename}', '${file.file_type}')" class="px-3 py-1 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600 transition-colors">
                                                        <i class="fas fa-paperclip mr-1"></i> Attach
                                                    </button>
                                                    <button onclick="deleteFile('${file.file_id}')" class="px-3 py-1 bg-red-500 text-white text-sm rounded-lg hover:bg-red-600 transition-colors">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);

            } catch (error) {
                showToast('Failed to load files', 'error');
            }
        }

        function closeFilesModal() {
            const modal = document.getElementById('filesModal');
            if (modal) modal.remove();
        }

        window.attachFile = function(file_id, filename, file_type) {
            // Check if already attached
            if (window.uploadedFiles.find(f => f.file_id === file_id)) {
                showToast('File already attached', 'warning');
                return;
            }

            window.uploadedFiles.push({ file_id, filename, file_type });
            window.updateUploadedFilesDisplay();
            showToast(`${filename} attached to chat`, 'success');
            closeFilesModal();
        }

        window.deleteFile = async function(file_id) {
            if (!confirm('Are you sure you want to delete this file?')) return;

            const token = localStorage.getItem('access_token') || localStorage.getItem('token');

            try {
                const response = await fetch(`${window.API_BASE}/files/${file_id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to delete file');

                showToast('File deleted successfully', 'success');

                // Remove from attached files if present
                window.uploadedFiles = window.uploadedFiles.filter(f => f.file_id !== file_id);
                window.updateUploadedFilesDisplay();

                // Refresh modal
                closeFilesModal();
                setTimeout(() => showUploadedFilesModal(), 300);

            } catch (error) {
                showToast('Failed to delete file', 'error');
            }
        }
    </script>
</body>
</html>
